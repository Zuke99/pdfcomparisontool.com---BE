name: Deploy to VPS (main)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Debug secrets (they will appear masked)
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          echo "ðŸ” SERVER_IP = ${SERVER_IP}"
          echo "ðŸ” SERVER_USER = ${SERVER_USER}"
          echo "ðŸ” SERVER_PASS = ${SERVER_PASS}"

      - name: Create archive from git HEAD
        run: |
          TARFILE=deploy_package.tar.gz
          rm -f "$TARFILE"
          echo "Creating tar from HEAD..."
          git archive --format=tar.gz -o "$TARFILE" HEAD

      - name: Copy archive to server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          TARFILE=deploy_package.tar.gz
          echo "Uploading archive -> ${SERVER_IP}"
          sshpass -p "${SERVER_PASS}" scp -o StrictHostKeyChecking=no "$TARFILE" "${SERVER_USER}@${SERVER_IP}:/tmp/$TARFILE"

      - name: Extract, install deps & restart PM2 on server
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_PASS: ${{ secrets.SERVER_PASS }}
        run: |
          STATIC_TARGET_DIR="/usr/local/www/pdfcomparisontool.com---BE"
          TARFILE="/tmp/deploy_package.tar.gz"

          echo "Deploy target directory: $STATIC_TARGET_DIR"

          sshpass -p "${SERVER_PASS}" ssh -o StrictHostKeyChecking=no "${SERVER_USER}@${SERVER_IP}" \
            "bash -lc 'set -e
              echo \"Deploying to: $STATIC_TARGET_DIR\";
              mkdir -p \"$STATIC_TARGET_DIR\";
              tar -xzf \"$TARFILE\" -C \"$STATIC_TARGET_DIR\";
              rm -f \"$TARFILE\";

              cd \"$STATIC_TARGET_DIR\";
              echo \"Installing dependencies...\";
              if command -v npm >/dev/null 2>&1; then
                npm ci --production || npm install --production;
              fi;

              APP_NAME=pdfcompare;

              echo \"Restarting PM2...\";
              if pm2 describe \"\$APP_NAME\" >/dev/null 2>&1; then
                pm2 restart \"\$APP_NAME\" || true;
              fi;

              pm2 restart \"\$APP_NAME\" || PORT=5001 pm2 start app.js --name \"\$APP_NAME\";
              pm2 save;
            '"

      - name: Cleanup local archive
        run: rm -f deploy_package.tar.gz
